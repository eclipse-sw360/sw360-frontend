// Copyright (C) Siemens AG, 2023. Part of the SW360 Frontend Project.

// This program and the accompanying materials are made
// available under the terms of the Eclipse Public License 2.0
// which is available at https://www.eclipse.org/legal/epl-2.0/

// SPDX-License-Identifier: EPL-2.0
// License-Filename: LICENSE

'use client'

import { signOut, useSession } from 'next-auth/react'
import { useTranslations } from 'next-intl'
import { notFound } from 'next/navigation'
import { ReactNode, useEffect, useState } from 'react'
import { Col, ListGroup, Row, Spinner, Tab } from 'react-bootstrap'

import { HttpStatus, Vulnerability } from '@/object-types'
import { ApiUtils } from '@/utils'
import Summary from './Summary'

export default function VulnerabilityDetailsTab({ vulnerabilityId }: { vulnerabilityId: string }): ReactNode {
    const t = useTranslations('default')
    const { data: session, status } = useSession()
    const [summaryData, setSummaryData] = useState<Vulnerability | undefined>(undefined)

    useEffect(() => {
        if (status !== 'authenticated') return
        const controller = new AbortController()
        const signal = controller.signal

        void (async () => {
            try {
                const response = await ApiUtils.GET(
                    `vulnerabilities/${vulnerabilityId}`,
                    session.user.access_token,
                    signal,
                )
                if (response.status === HttpStatus.UNAUTHORIZED) {
                    return signOut()
                } else if (response.status !== HttpStatus.OK) {
                    return notFound()
                }

                const data = (await response.json()) as Vulnerability

                setSummaryData(data)
            } catch (e) {
                console.error(e)
            }
        })()

        return () => controller.abort()
    }, [vulnerabilityId, session])

    return (
        <>
            <div className='ms-5 mt-2'>
                <Tab.Container defaultActiveKey='summary'>
                    <Row>
                        <Col
                            sm='2'
                            className='me-3'
                        >
                            <ListGroup>
                                <ListGroup.Item
                                    action
                                    eventKey='summary'
                                >
                                    <div className='my-2'>{t('Summary')}</div>
                                </ListGroup.Item>
                                <ListGroup.Item
                                    action
                                    eventKey='metadata'
                                >
                                    <div className='my-2'>{t('Metadata')}</div>
                                </ListGroup.Item>
                                <ListGroup.Item
                                    action
                                    eventKey='references'
                                >
                                    <div className='my-2'>{t('References')}</div>
                                </ListGroup.Item>
                            </ListGroup>
                        </Col>
                        <Col className='ps-2 me-3'>
                            <Row>
                                <Tab.Content>
                                    <Tab.Pane eventKey='summary'>
                                        {!summaryData ? (
                                            <div
                                                className='col-12'
                                                style={{ textAlign: 'center' }}
                                            >
                                                <Spinner className='spinner' />
                                            </div>
                                        ) : (
                                            <Summary summaryData={summaryData} />
                                        )}
                                    </Tab.Pane>
                                    <Tab.Pane eventKey='metadata'></Tab.Pane>
                                    <Tab.Pane eventKey='references'></Tab.Pane>
                                </Tab.Content>
                            </Row>
                        </Col>
                    </Row>
                </Tab.Container>
            </div>
        </>
    )
}
